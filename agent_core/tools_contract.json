{
  "version": "1.0.1",
  "config": {
    "strict_mode": true,
    "required_parameter_all": "clinic_id",
    "forbid_actions_without_clinic_id": true
  },
  "functions": [
    {
      "name": "identify_clinic_by_phone",
      "description": "Determina el clinic_id basándose en el DID (número al que el usuario ha llamado). Ejecutar al inicio si clinic_id no viene en el contexto.",
      "parameters": {
        "type": "object",
        "properties": {
          "did": { "type": "string", "description": "Número destino (DID) en formato E.164." }
        },
        "required": ["did"]
      },
      "output": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" },
          "clinic_display_name": { "type": "string" }
        },
        "required": ["clinic_id"]
      },
      "error_cases": ["DID_NOT_FOUND", "CLINIC_INACTIVE"]
    },
    {
      "name": "find_patient_by_phone",
      "description": "Busca un paciente en la base de datos de la clínica por su número de teléfono.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" },
          "phone": { "type": "string", "description": "Teléfono del llamante en formato E.164 si es posible." }
        },
        "required": ["clinic_id", "phone"]
      },
      "output": {
        "type": "object",
        "properties": {
          "found": { "type": "boolean" },
          "patient": {
            "type": ["object", "null"],
            "properties": {
              "id": { "type": "string" },
              "full_name": { "type": "string" }
            }
          }
        },
        "required": ["found"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "DB_ERROR"]
    },
    {
      "name": "list_services",
      "description": "Lista los servicios activos de la clínica para evitar inventar tratamientos.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" }
        },
        "required": ["clinic_id"]
      },
      "output": {
        "type": "object",
        "properties": {
          "services": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": { "type": "string" },
                "name": { "type": "string" },
                "duration_minutes": { "type": "integer" }
              },
              "required": ["id", "name"]
            }
          }
        },
        "required": ["services"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "DB_ERROR"]
    },
    {
      "name": "list_doctors",
      "description": "Lista doctores activos por clínica o sede para evitar inventar médicos.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" },
          "branch_id": { "type": ["string", "null"] }
        },
        "required": ["clinic_id"]
      },
      "output": {
        "type": "object",
        "properties": {
          "doctors": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": { "type": "string" },
                "full_name": { "type": "string" },
                "specialty": { "type": ["string", "null"] },
                "branch_id": { "type": ["string", "null"] }
              },
              "required": ["id", "full_name"]
            }
          }
        },
        "required": ["doctors"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "DB_ERROR"]
    },
    {
      "name": "list_branches",
      "description": "Lista sedes activas de la clínica.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" }
        },
        "required": ["clinic_id"]
      },
      "output": {
        "type": "object",
        "properties": {
          "branches": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": { "type": "string" },
                "name": { "type": "string" },
                "city": { "type": ["string", "null"] }
              },
              "required": ["id", "name"]
            }
          }
        },
        "required": ["branches"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "DB_ERROR"]
    },
    {
      "name": "find_available_slots",
      "description": "Busca huecos libres en la agenda filtrando por doctor, sede o servicio.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" },
          "branch_id": { "type": ["string", "null"] },
          "doctor_id": { "type": ["string", "null"] },
          "service_id": { "type": ["string", "null"] },
          "date_range_start": { "type": "string", "format": "date-time" },
          "date_range_end": { "type": "string", "format": "date-time" }
        },
        "required": ["clinic_id", "date_range_start", "date_range_end"]
      },
      "output": {
        "type": "object",
        "properties": {
          "slots": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "start_at": { "type": "string", "format": "date-time" },
                "end_at": { "type": "string", "format": "date-time" },
                "doctor_id": { "type": ["string", "null"] },
                "branch_id": { "type": ["string", "null"] }
              },
              "required": ["start_at", "end_at"]
            }
          }
        },
        "required": ["slots"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "NO_AVAILABILITY", "DB_ERROR"]
    },
    {
      "name": "create_appointment",
      "description": "Registra una nueva cita. Requiere confirmación verbal previa del usuario.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" },
          "patient_id": { "type": "string" },
          "doctor_id": { "type": "string" },
          "branch_id": { "type": "string" },
          "service_id": { "type": "string" },
          "start_at": { "type": "string", "format": "date-time" }
        },
        "required": ["clinic_id", "patient_id", "doctor_id", "branch_id", "service_id", "start_at"]
      },
      "output": {
        "type": "object",
        "properties": {
          "appointment_id": { "type": "string" },
          "status": { "type": "string" }
        },
        "required": ["appointment_id"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "SLOT_TAKEN", "VALIDATION_ERROR", "DB_ERROR"]
    },
    {
      "name": "reschedule_appointment",
      "description": "Reprograma una cita existente a una nueva fecha/hora.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" },
          "appointment_id": { "type": "string" },
          "new_start_at": { "type": "string", "format": "date-time" }
        },
        "required": ["clinic_id", "appointment_id", "new_start_at"]
      },
      "output": {
        "type": "object",
        "properties": {
          "appointment_id": { "type": "string" },
          "status": { "type": "string" }
        },
        "required": ["appointment_id"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "NOT_FOUND", "SLOT_TAKEN", "DB_ERROR"]
    },
    {
      "name": "cancel_appointment",
      "description": "Cancela una cita existente. Requiere confirmación verbal previa del usuario.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" },
          "appointment_id": { "type": "string" },
          "reason": { "type": ["string", "null"] }
        },
        "required": ["clinic_id", "appointment_id"]
      },
      "output": {
        "type": "object",
        "properties": {
          "appointment_id": { "type": "string" },
          "status": { "type": "string" }
        },
        "required": ["appointment_id"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "NOT_FOUND", "DB_ERROR"]
    },
    {
      "name": "create_call_session",
      "description": "Crea el registro inicial de una llamada para auditoría y analítica.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" },
          "phone_from": { "type": "string" },
          "phone_to": { "type": "string" },
          "started_at": { "type": "string", "format": "date-time" }
        },
        "required": ["clinic_id", "phone_from", "phone_to", "started_at"]
      },
      "output": {
        "type": "object",
        "properties": {
          "call_session_id": { "type": "string" }
        },
        "required": ["call_session_id"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "DB_ERROR"]
    },
    {
      "name": "close_call_session",
      "description": "Finaliza la sesión, guarda el resumen y el resultado de la llamada para analítica.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" },
          "call_session_id": { "type": "string" },
          "outcome": {
            "type": "string",
            "enum": ["APPOINTMENT_CREATED", "APPOINTMENT_RESCHEDULED", "APPOINTMENT_CANCELLED", "INFO_GIVEN", "TRANSFERRED", "ABANDONED"]
          },
          "summary": { "type": "string", "description": "Resumen de 1 frase de la llamada." }
        },
        "required": ["clinic_id", "call_session_id", "outcome", "summary"]
      },
      "output": {
        "type": "object",
        "properties": {
          "ok": { "type": "boolean" }
        },
        "required": ["ok"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "NOT_FOUND", "DB_ERROR"]
    },
    {
      "name": "record_usage",
      "description": "Registra consumo (tokens/segundos de audio) para control de costes por clínica y por llamada.",
      "parameters": {
        "type": "object",
        "properties": {
          "clinic_id": { "type": "string" },
          "call_session_id": { "type": "string" },
          "model": { "type": ["string", "null"] },
          "input_tokens": { "type": "integer" },
          "output_tokens": { "type": "integer" },
          "audio_seconds_in": { "type": "integer" },
          "audio_seconds_out": { "type": "integer" }
        },
        "required": ["clinic_id", "call_session_id", "input_tokens", "output_tokens", "audio_seconds_in", "audio_seconds_out"]
      },
      "output": {
        "type": "object",
        "properties": {
          "ok": { "type": "boolean" }
        },
        "required": ["ok"]
      },
      "error_cases": ["INVALID_CLINIC_ID", "DB_ERROR"]
    }
  ]
}